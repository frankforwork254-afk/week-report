<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>é€±å ±ç”¢ç”Ÿå™¨</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    h2 { margin-top: 20px; }
    .project, .recipient { border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 5px; }
    .project input, .recipient input, textarea { margin: 5px; }
    button { margin: 5px; padding: 5px 10px; }
    textarea { width: 100%; margin-top: 10px; }
    .subject-preview { margin: 10px 0; font-weight: bold; color: darkblue; }
    .settings { margin: 15px 0; padding: 10px; border: 1px dashed #999; border-radius: 5px; }
  </style>
</head>
<body>
  <h1>å°ˆæ¡ˆé€±å ±ç”¢ç”Ÿå™¨</h1>

  <h2>æ”¶ä»¶äººè¨­å®š</h2>
  <div id="recipientsBox"></div>
  <button onclick="addRecipient()">æ–°å¢æ”¶ä»¶äºº</button>

  <div class="subject-preview">
    ğŸ“Œ ä¸»æ—¨é è¦½ï¼š<span id="subjectPreview"></span>
  </div>

  <h2>å¯„é€è¨­å®š</h2>
  <div class="settings">
    <label>
      <input type="radio" name="sendMode" value="outlook" onchange="saveData()"> åªç”¨ Outlook
    </label><br>
    <label>
      <input type="radio" name="sendMode" value="fallback" onchange="saveData()"> Outlook + Mail å‚™æ´
    </label>
  </div>

  <h2>æœ¬é€±</h2>
  <div id="thisWeek"></div>
  <button onclick="addProject('thisWeek')">æ–°å¢æœ¬é€±å°ˆæ¡ˆ</button>

  <h2>ä¸‹é€±</h2>
  <div id="nextWeek"></div>
  <button onclick="addProject('nextWeek')">æ–°å¢ä¸‹é€±å°ˆæ¡ˆ</button>
  <button onclick="moveNextToThis()">ä¸‹é€± â†’ æœ¬é€±</button>

  <h2>ç°½åæª”</h2>
  <textarea id="signature" placeholder="è¼¸å…¥ç°½åæª”..." rows="4" style="width:100%;" oninput="saveData()"></textarea>

  <h2>è¼¸å‡º</h2>
  <button onclick="generateReport()">ç”Ÿæˆé€±å ±</button>
  <textarea id="report" rows="12"></textarea>
  <br>
  <button onclick="sendOutlook()">å¯„é€åˆ° Outlook</button>

  <script>
    // ====== æ—¥æœŸè™•ç† ======
    function getWeekRange(offset = 0) {
      const today = new Date();
      const first = today.getDate() - today.getDay() + 1 + offset * 7; // é€±ä¸€
      const last = first + 6; // é€±æ—¥
      const start = new Date(today.setDate(first));
      const end = new Date(today.setDate(last));
      return [start, end];
    }

    function formatDate(date) {
      return date.toISOString().split('T')[0].replace(/-/g, '/');
    }

    function updateSubjectPreview() {
      const [thisStart, thisEnd] = getWeekRange(0);
      const subjectText = `é€±å ± (${formatDate(thisStart)} ~ ${formatDate(thisEnd)})`;
      document.getElementById("subjectPreview").innerText = subjectText;
      return subjectText;
    }

    // ====== æ”¶ä»¶äººè™•ç† ======
    function addRecipient(value = "") {
      const container = document.getElementById("recipientsBox");
      const div = document.createElement("div");
      div.className = "recipient";
      div.innerHTML = `
        æ”¶ä»¶äºº: <input type="email" placeholder="example@domain.com" value="${value}" oninput="saveData()">
        <button onclick="this.parentNode.remove(); saveData()">åˆªé™¤</button>
      `;
      container.appendChild(div);
      saveData();
    }

    function getRecipients() {
      const recipients = [];
      document.querySelectorAll("#recipientsBox input").forEach(input => {
        if (input.value.trim()) {
          recipients.push(input.value.trim());
        }
      });
      return recipients;
    }

    // ====== å°ˆæ¡ˆè™•ç† ======
    function addProject(containerId, values = {}) {
      const container = document.getElementById(containerId);
      const div = document.createElement("div");
      div.className = "project";
      div.innerHTML = `
        å®¢æˆ¶: <input type="text" placeholder="å®¢æˆ¶åç¨±" value="${values.client || ''}" oninput="saveData()"><br>
        å°ˆæ¡ˆ: <input type="text" placeholder="å°ˆæ¡ˆåç¨±" value="${values.project || ''}" oninput="saveData()"><br>
        é€²åº¦: <input type="text" placeholder="é€²åº¦æè¿°" value="${values.progress || ''}" oninput="saveData()"><br>
        é”æˆç‡: <input type="number" min="0" max="100" value="${values.completion || 0}" oninput="saveData()">%<br>
        <button onclick="this.parentNode.remove(); saveData()">åˆªé™¤</button>
      `;
      container.appendChild(div);
      saveData();
    }

    function moveNextToThis() {
      const nextProjects = document.querySelectorAll("#nextWeek .project");
      nextProjects.forEach(proj => {
        const inputs = proj.querySelectorAll("input");
        const values = {
          client: inputs[0].value,
          project: inputs[1].value,
          progress: inputs[2].value,
          completion: inputs[3].value
        };
        addProject("thisWeek", values);
      });
      document.getElementById("nextWeek").innerHTML = ""; // æ¸…ç©ºä¸‹é€±
      saveData();
    }

    // ====== é€±å ±ç”Ÿæˆ ======
    function generateReport() {
      const [thisStart, thisEnd] = getWeekRange(0);
      const [nextStart, nextEnd] = getWeekRange(1);
      let report = "";

      // æœ¬é€±
      report += `æœ¬é€± (${formatDate(thisStart)} ~ ${formatDate(thisEnd)})\n`;
      document.querySelectorAll("#thisWeek .project").forEach((proj, i) => {
        const inputs = proj.querySelectorAll("input");
        report += `${i+1}. ${inputs[0].value} - ${inputs[1].value}\n`;
        report += `é€²åº¦ï¼š${inputs[2].value}\n`;
        report += `é”æˆç‡ï¼š${inputs[3].value}%\n\n`;
      });

      // ä¸‹é€±
      report += `ä¸‹é€± (${formatDate(nextStart)} ~ ${formatDate(nextEnd)})\n`;
      document.querySelectorAll("#nextWeek .project").forEach((proj, i) => {
        const inputs = proj.querySelectorAll("input");
        report += `${i+1}. ${inputs[0].value} - ${inputs[1].value}\n`;
        report += `é€²åº¦ï¼š${inputs[2].value}\n`;
        report += `é”æˆç‡ï¼š${inputs[3].value}%\n\n`;
      });

      // ç°½åæª”
      const signature = document.getElementById("signature").value.trim();
      if (signature) {
        report += `\n--\n${signature}`;
      }

      document.getElementById("report").value = report;
      updateSubjectPreview();
    }

    // ====== å¯„é€ ======
    function sendOutlook() {
      const subjectText = updateSubjectPreview();
      const subject = encodeURIComponent(subjectText);
      const body = encodeURIComponent(document.getElementById("report").value);
      const recipients = encodeURIComponent(getRecipients().join(";"));

      const sendMode = document.querySelector('input[name="sendMode"]:checked')?.value || "outlook";

      if (sendMode === "outlook") {
        // åªç”¨ Outlook
        const outlookUrl = `outlook://compose?to=${recipients}&subject=${subject}&body=${body}`;
        window.location.href = outlookUrl;
      } else {
        // Outlook + Mail å‚™æ´
        const outlookUrl = `outlook://compose?to=${recipients}&subject=${subject}&body=${body}`;
        window.location.href = outlookUrl;
        setTimeout(() => {
          window.location.href = `mailto:${recipients}?subject=${subject}&body=${body}`;
        }, 300); // ç¸®çŸ­å»¶é²
      }
    }

    // ====== è‡ªå‹•å„²å­˜ / è¼‰å…¥ ======
    function saveData() {
      const data = {
        recipients: getRecipients(),
        signature: document.getElementById("signature").value,
        sendMode: document.querySelector('input[name="sendMode"]:checked')?.value || "outlook",
        thisWeek: [],
        nextWeek: []
      };

      document.querySelectorAll("#thisWeek .project").forEach(proj => {
        const inputs = proj.querySelectorAll("input");
        data.thisWeek.push({
          client: inputs[0].value,
          project: inputs[1].value,
          progress: inputs[2].value,
          completion: inputs[3].value
        });
      });

      document.querySelectorAll("#nextWeek .project").forEach(proj => {
        const inputs = proj.querySelectorAll("input");
        data.nextWeek.push({
          client: inputs[0].value,
          project: inputs[1].value,
          progress: inputs[2].value,
          completion: inputs[3].value
        });
      });

      localStorage.setItem("weeklyReportData", JSON.stringify(data));
    }

    function loadData() {
      const raw = localStorage.getItem("weeklyReportData");
      if (!raw) {
        updateSubjectPreview();
        return;
      }
      const data = JSON.parse(raw);

      (data.recipients || []).forEach(r => addRecipient(r));
      (data.thisWeek || []).forEach(p => addProject("thisWeek", p));
      (data.nextWeek || []).forEach(p => addProject("nextWeek", p));
      document.getElementById("signature").value = data.signature || "";

      // å¯„é€æ¨¡å¼
      if (data.sendMode) {
        document.querySelector(`input[name="sendMode"][value="${data.sendMode}"]`).checked = true;
      } else {
        document.querySelector('input[name="sendMode"][value="outlook"]').checked = true;
      }

      updateSubjectPreview();
    }

    window.onload = loadData;
  </script>
</body>
</html>
